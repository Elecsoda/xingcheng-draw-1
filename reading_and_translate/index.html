<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å­¦æ•°å­¦æ€ç»´è®­ç»ƒ v4.0</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f8fafc; }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* é¢˜ç›®æ–‡æœ¬æ ·å¼ */
        .problem-text { line-height: 2.2; font-size: 1.15rem; color: #334155; }
        .highlight-segment { 
            border-bottom: 2px solid transparent; 
            padding: 2px 4px; 
            margin: 0 1px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .highlight-segment.active {
            background-color: #fef08a; border-bottom-color: #ca8a04; color: #854d0e; font-weight: bold;
            box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.2);
        }
        .highlight-segment.completed {
            background-color: #dcfce7; border-bottom-color: #16a34a; color: #166534; font-weight: 500;
        }

        /* å¡«ç©ºè¾“å…¥æ¡† */
        .input-box {
            border: 2px solid #cbd5e1; border-radius: 8px; padding: 6px 10px; text-align: center; width: 90px;
            font-weight: bold; color: #1e293b; transition: all 0.2s;
        }
        .input-box:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .input-box.correct { border-color: #22c55e; background-color: #f0fdf4; color: #15803d; }
        .input-box.wrong { border-color: #ef4444; background-color: #fef2f2; color: #b91c1c; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- é¢˜åº“æ•°æ® ---
        const problems = [
            // é¢˜ç›® 1: å¹´é¾„é—®é¢˜ (å·®å€)
            {
                id: 1,
                title: "å¹´é¾„é—®é¢˜ (å·®å€æ¨¡å‹)",
                content: [
                    { text: "çˆ¸çˆ¸ä»Šå¹´", id: "p1" },
                    { text: "æ¯”å„¿å­å¤§32å²", id: "rel1", type: "relation", question: "è¿™å¥è¯è¯´æ˜äº†ä»€ä¹ˆæ•°é‡å…³ç³»ï¼Ÿ", 
                      options: [
                          { text: "çˆ¸çˆ¸ - å„¿å­ = 32", correct: true },
                          { text: "çˆ¸çˆ¸ + å„¿å­ = 32", correct: false }
                      ] 
                    },
                    { text: "ã€‚", id: "p2" },
                    { text: "8å¹´å", id: "time", type: "condition", question: "8å¹´åï¼Œä¸¤äººçš„å¹´é¾„å·®ä¼šå˜å—ï¼Ÿ", 
                      options: [
                          { text: "å˜å¤§ (éƒ½é•¿äº†8å²)", correct: false },
                          { text: "ä¸å˜ (å·®ä»ç„¶æ˜¯32å²)", correct: true }
                      ]
                    },
                    { text: "ï¼Œçˆ¸çˆ¸çš„å¹´é¾„æ˜¯", id: "p3" },
                    { text: "å„¿å­çš„3å€", id: "rel2", type: "relation", question: "æ­¤æ—¶ä¸¤äººçš„å€æ•°å…³ç³»æ˜¯ï¼Ÿ", 
                      options: [
                          { text: "çˆ¸çˆ¸ = å„¿å­ Ã— 3", correct: true },
                          { text: "å„¿å­ = çˆ¸çˆ¸ Ã— 3", correct: false }
                      ]
                    },
                    { text: "ã€‚è¯·é—®å„¿å­ä»Šå¹´å¤šå°‘å²ï¼Ÿ", id: "q1" }
                ],
                diagramData: {
                    type: "age_diff", diffValue: 32, multiple: 3, labels: { small: "å„¿å­", big: "çˆ¸çˆ¸" },
                    questions: [
                        { label: "å¹´é¾„å·®æ˜¯å‡ å²ï¼Ÿ", answer: "32", unit: "å²" },
                        { label: "å›¾ä¸Šå¤šå‡ºçš„éƒ¨åˆ†æ˜¯å‡ ä»½ï¼Ÿ(3å€-1å€)", answer: "2", unit: "ä»½" },
                        { label: "8å¹´åå„¿å­å‡ å²ï¼Ÿ(å·®Ã·ä»½æ•°)", answer: "16", unit: "å²" },
                        { label: "å„¿å­ä»Šå¹´å‡ å²ï¼Ÿ(16-8)", answer: "8", unit: "å²" }
                    ]
                }
            },
            // é¢˜ç›® 2: å’Œå·®é—®é¢˜ (ç§»å¤šè¡¥å°‘)
            {
                id: 2,
                title: "å’Œå·®é—®é¢˜ (ç»™æ¥ç»™å»)",
                content: [
                    { text: "ç”²ã€ä¹™ä¸¤ä¸ªç­", id: "p1" },
                    { text: "å…±æœ‰å›¾ä¹¦96æœ¬", id: "rel1", type: "relation", question: "è¿™å¥è¯å‘Šè¯‰æˆ‘ä»¬ä»€ä¹ˆä¸å˜ï¼Ÿ", 
                      options: [
                          { text: "å›¾ä¹¦çš„æ€»æ•° (å’Œ) ä¸å˜", correct: true },
                          { text: "ä¸¤ä¸ªç­çš„å·®ä¸å˜", correct: false }
                      ] 
                    },
                    { text: "ã€‚å¦‚æœ", id: "p2" },
                    { text: "ç”²ç­ç»™ä¹™ç­8æœ¬", id: "act1", type: "action", question: "ç”²ç»™ä¹™8æœ¬åï¼Œç”²ä¹™çš„æ•°é‡å…³ç³»æ˜¯ï¼Ÿ", 
                      options: [
                          { text: "ç”²å‡å°‘8ï¼Œä¹™å¢åŠ 8", correct: true },
                          { text: "ç”²å˜å¤šäº†", correct: false }
                      ]
                    },
                    { text: "ï¼Œ", id: "p3" },
                    { text: "ä¸¤ä¸ªç­å°±ä¸€æ ·å¤š", id: "rel2", type: "relation", question: "ç°åœ¨æ¯ä¸ªç­æœ‰å¤šå°‘æœ¬ï¼Ÿ", 
                      options: [
                          { text: "96 Ã· 2 = 48 æœ¬", correct: true },
                          { text: "æ— æ³•ç¡®å®š", correct: false }
                      ]
                    },
                    { text: "ã€‚ç”²ç­åŸæ¥æœ‰å¤šå°‘æœ¬ï¼Ÿ", id: "q1" }
                ],
                diagramData: {
                    type: "transfer", total: 96, transfer: 8, labels: { a: "ç”²ç­", b: "ä¹™ç­" },
                    questions: [
                        { label: "ç°åœ¨ç”²ç­æœ‰å¤šå°‘æœ¬ï¼Ÿ(æ€»æ•°Ã·2)", answer: "48", unit: "æœ¬" },
                        { label: "ç”²ç­åŸæ¥æ˜¯å¤šå°‘ï¼Ÿ(å€’æ¨: 48+8)", answer: "56", unit: "æœ¬" }
                    ]
                }
            },
            // é¢˜ç›® 3: è¿˜åŸé—®é¢˜ (ä¸‰äººå€’æ¨) - æ–°å¢
            {
                id: 3,
                title: "è¿˜åŸé—®é¢˜ (ä¸‰äººåˆ†è„¸è°±)",
                content: [
                    { text: "å¼ ã€æã€ç‹ä¸‰äºº", id: "p1" },
                    { text: "ä¸€å…±ç”»äº†21å¼ è„¸è°±", id: "data1", type: "relation", question: "è¿™æ˜¯ä»€ä¹ˆé‡ä¸å˜ï¼Ÿ", 
                      options: [
                          { text: "æ€»æ•°ä¸å˜", correct: true },
                          { text: "æ¯ä¸ªäººæ•°é‡ä¸å˜", correct: false }
                      ]
                    },
                    { text: "ã€‚å¦‚æœå¼ ç»™æ3å¼ ï¼Œ", id: "act1" },
                    { text: "æå†ç»™ç‹2å¼ ", id: "act2", type: "action", question: "è¿™æ¶‰åŠåˆ°å“ªä¸¤ä¸ªäººçš„å˜åŒ–ï¼Ÿ", 
                      options: [
                          { text: "æå‡å°‘2ï¼Œç‹å¢åŠ 2", correct: true },
                          { text: "å¼ å‡å°‘2ï¼Œç‹å¢åŠ 2", correct: false }
                      ]
                    },
                    { text: "ï¼Œ", id: "p2" },
                    { text: "ä¸‰äººå°±ä¸€æ ·å¤š", id: "res", type: "relation", question: "æœ€åæ¯ä¸ªäººæœ‰å¤šå°‘å¼ ï¼Ÿ", 
                      options: [
                          { text: "21 Ã· 3 = 7 å¼ ", correct: true },
                          { text: "æ— æ³•è®¡ç®—", correct: false }
                      ]
                    },
                    { text: "ã€‚æå¸ˆå‚…åŸæ¥ç”»äº†å¤šå°‘å¼ ï¼Ÿ", id: "q1" }
                ],
                diagramData: {
                    type: "multi_transfer", total: 21, finalEach: 7, 
                    steps: [{ from: "å¼ ", to: "æ", val: 3 }, { from: "æ", to: "ç‹", val: 2 }],
                    labels: ["å¼ ", "æ", "ç‹"],
                    questions: [
                        { label: "æœ€åæå¸ˆå‚…æœ‰å‡ å¼ ï¼Ÿ", answer: "7", unit: "å¼ " },
                        { label: "ç»™ç‹2å¼ ä¹‹å‰ï¼Œææœ‰å‡ å¼ ï¼Ÿ(7+2)", answer: "9", unit: "å¼ " },
                        { label: "æ”¶å¼ 3å¼ ä¹‹å‰(åŸæ¥)ï¼Œææœ‰å‡ å¼ ï¼Ÿ(9-3)", answer: "6", unit: "å¼ " }
                    ]
                }
            },
            // é¢˜ç›® 4: ç›ˆäºé—®é¢˜ (ç»³å­æµ‹æ¥¼) - æ–°å¢
            {
                id: 4,
                title: "ç›ˆäºé—®é¢˜ (ç»³å­æµ‹æ¥¼)",
                content: [
                    { text: "ç”¨ç»³å­æµ‹æ¥¼é«˜ã€‚", id: "p1" },
                    { text: "æŠ˜æˆ4æ®µé‡ï¼Œç»³æ¯”æ¥¼é«˜5ç±³", id: "c1", type: "relation", question: "è¿™è¯´æ˜ç»³å­æ€»é•¿æ˜¯å¤šå°‘ï¼Ÿ", 
                      options: [
                          { text: "4 Ã— (æ¥¼é«˜ + 5)", correct: true },
                          { text: "4 Ã— æ¥¼é«˜ + 5", correct: false }
                      ]
                    },
                    { text: "ï¼›", id: "p2" },
                    { text: "æŠ˜æˆ5æ®µé‡ï¼Œç»³æ¯”æ¥¼é«˜2ç±³", id: "c2", type: "relation", question: "è¿™è¯´æ˜ç»³å­æ€»é•¿è¿˜å¯ä»¥æ€ä¹ˆè¡¨ç¤ºï¼Ÿ", 
                      options: [
                          { text: "5 Ã— (æ¥¼é«˜ + 2)", correct: true },
                          { text: "5 Ã— (æ¥¼é«˜ - 2)", correct: false }
                      ]
                    },
                    { text: "ã€‚ç»³å­æœ‰å¤šå°‘ç±³ï¼Ÿ", id: "q1" }
                ],
                diagramData: {
                    type: "rope_measure", 
                    cond1: { parts: 4, extra: 5 }, 
                    cond2: { parts: 5, extra: 2 },
                    questions: [
                        { label: "4æ®µæ—¶ï¼Œç»³å­æ€»å…±æ¯”4å€æ¥¼é«˜å¤šå¤šå°‘ï¼Ÿ(4Ã—5)", answer: "20", unit: "ç±³" },
                        { label: "5æ®µæ—¶ï¼Œç»³å­æ€»å…±æ¯”5å€æ¥¼é«˜å¤šå¤šå°‘ï¼Ÿ(5Ã—2)", answer: "10", unit: "ç±³" },
                        { label: "æ¥¼é«˜æ˜¯å¤šå°‘ï¼Ÿ(å·®Ã·å·®: (20-10)Ã·(5-4))", answer: "10", unit: "ç±³" },
                        { label: "ç»³å­å¤šé•¿ï¼Ÿ(4Ã—(10+5))", answer: "60", unit: "ç±³" }
                    ]
                }
            },
            // é¢˜ç›® 5: å¤æ‚å¹´é¾„ (æ—¶å…‰è½´) - æ–°å¢
            {
                id: 5,
                title: "å¹´é¾„é—®é¢˜ (æ—¶å…‰ç©¿æ¢­)",
                content: [
                    { text: "è€å¸ˆå¯¹å°æ˜è¯´ï¼š", id: "p1" },
                    { text: "â€œä½ æ˜¯æˆ‘è¿™ä¹ˆå¤§æ—¶ï¼Œæˆ‘å·²ç»44å²äº†â€", id: "c1", type: "relation", question: "è¿™å¥è¯æ˜¯åœ¨è¯´è°çš„å¹´é¾„ï¼Ÿ", 
                      options: [
                          { text: "æœªæ¥çš„äº‹ (ä¸¤äººéƒ½å˜è€äº†)", correct: true },
                          { text: "è¿‡å»çš„äº‹", correct: false }
                      ]
                    },
                    { text: "ï¼›", id: "p2" },
                    { text: "â€œæˆ‘æ˜¯ä½ è¿™ä¹ˆå¤§æ—¶ï¼Œä½ æ‰2å²â€", id: "c2", type: "relation", question: "è¿™å¥è¯æ˜¯åœ¨è¯´è°çš„å¹´é¾„ï¼Ÿ", 
                      options: [
                          { text: "è¿‡å»çš„äº‹ (ä¸¤äººéƒ½å˜å¹´è½»äº†)", correct: true },
                          { text: "ç°åœ¨çš„å¹´é¾„", correct: false }
                      ]
                    },
                    { text: "ã€‚è€å¸ˆä»Šå¹´å¤šå°‘å²ï¼Ÿ", id: "q1" }
                ],
                diagramData: {
                    type: "age_timeline", low: 2, high: 44,
                    questions: [
                        { label: "ä»2å²åˆ°44å²ï¼Œä¸€å…±è·¨è¶Šäº†å‡ ä¸ªå¹´é¾„å·®ï¼Ÿ", answer: "3", unit: "ä¸ª", hint: "ç”»å›¾çœ‹ï¼šè¿‡å»->ç°åœ¨->æœªæ¥" },
                        { label: "ä¸¤äººçš„å¹´é¾„å·®æ˜¯å¤šå°‘ï¼Ÿ((44-2)Ã·3)", answer: "14", unit: "å²" },
                        { label: "è€å¸ˆä»Šå¹´å‡ å²ï¼Ÿ(2 + å·® + å·®)", answer: "30", unit: "å²" }
                    ]
                }
            }
        ];

        // --- å¯è§†åŒ–ç»„ä»¶ ---

        // 1. å·®å€å›¾ (å¹´é¾„)
        const AgeVisual = ({ data }) => (
            <div className="flex flex-col gap-4 w-full max-w-md mx-auto">
                <div className="text-xs text-center text-gray-500 mb-2">8å¹´åçš„æƒ…å†µ</div>
                <div className="flex items-center">
                    <div className="w-16 text-right pr-3 font-bold text-gray-600">{data.labels.small}</div>
                    <div className="h-10 bg-green-200 border-2 border-green-500 w-1/4 rounded flex items-center justify-center text-xs text-green-900 font-bold">1ä»½</div>
                </div>
                <div className="flex items-center relative">
                    <div className="w-16 text-right pr-3 font-bold text-gray-600">{data.labels.big}</div>
                    <div className="h-10 bg-blue-100 border-2 border-blue-500 w-3/4 rounded flex divide-x-2 divide-blue-400">
                        <div className="flex-1 flex items-center justify-center text-xs text-blue-800 bg-blue-200">1ä»½</div>
                        <div className="flex-1 flex items-center justify-center text-xs text-blue-800">1ä»½</div>
                        <div className="flex-1 flex items-center justify-center text-xs text-blue-800">1ä»½</div>
                    </div>
                    <div className="absolute left-[25%] right-0 -bottom-6 h-4 border-l border-r border-t border-red-400 flex items-start justify-center">
                        <span className="bg-red-50 text-red-600 text-[10px] px-1 rounded -mt-2">ç›¸å·® {data.diffValue} å²</span>
                    </div>
                </div>
            </div>
        );

        // 2. ç§»å¤šè¡¥å°‘å›¾ (å’Œå·®)
        const TransferVisual = ({ data }) => (
            <div className="flex gap-8 items-end h-40 w-full justify-center">
                <div className="relative w-20">
                    <div className="absolute -top-6 w-full text-center font-bold text-blue-700">{data.labels.a}</div>
                    <div className="h-28 bg-blue-200 border-2 border-blue-500 rounded-t-lg relative w-full">
                        <div className="absolute top-0 left-0 w-full h-6 bg-yellow-300 border-b border-dashed border-blue-600 flex items-center justify-center text-[10px] text-yellow-900">
                            -{data.transfer}
                        </div>
                    </div>
                    <div className="absolute top-0 -right-12 text-blue-400 text-xl">â”</div>
                </div>
                <div className="relative w-20">
                    <div className="absolute -top-6 w-full text-center font-bold text-green-700">{data.labels.b}</div>
                    <div className="h-22 bg-green-200 border-2 border-green-500 rounded-t-lg w-full flex items-end justify-center pb-2">
                        <span className="text-[10px] text-green-800">åŸæ¥</span>
                    </div>
                    <div className="absolute -top-6 left-0 w-full h-6 border-2 border-dashed border-green-400 rounded-t-lg opacity-50"></div>
                </div>
            </div>
        );

        // 3. å¤šäººå€’æ¨å›¾ (è¿˜åŸ)
        const MultiTransferVisual = ({ data }) => (
            <div className="flex justify-between items-center w-full px-4 h-40">
                {data.labels.map((name, i) => (
                    <div key={i} className="flex flex-col items-center relative">
                        <div className="w-16 h-20 bg-indigo-100 border-2 border-indigo-400 rounded-lg flex flex-col justify-end items-center p-2 relative">
                            <span className="text-2xl font-bold text-indigo-700">{data.finalEach}</span>
                            <span className="text-xs text-indigo-400">æœ€å</span>
                            {/* åŠ¨æ€æ ‡è®° */}
                            {i === 1 && (
                                <div className="absolute -top-4 w-full text-center text-xs bg-yellow-100 text-yellow-800 px-1 rounded border border-yellow-300">
                                    æˆ‘æ˜¯å…³é”®
                                </div>
                            )}
                        </div>
                        <span className="font-bold mt-2 text-gray-700">{name}</span>
                    </div>
                ))}
                {/* å€’æ¨ç®­å¤´è¦†ç›– */}
                <div className="absolute top-10 left-20 right-20 h-10 pointer-events-none">
                    <div className="absolute left-[20%] top-0 text-xs text-red-500 font-bold">â† é€†å‘: +3</div>
                    <div className="absolute right-[20%] top-0 text-xs text-green-500 font-bold">é€†å‘: +2 â†’</div>
                </div>
            </div>
        );

        // 4. ç»³å­æµ‹æ¥¼å›¾ (ç›ˆäº)
        const RopeVisual = ({ data }) => (
            <div className="flex gap-6 w-full justify-center items-end h-48">
                {/* æ¥¼æˆ¿ */}
                <div className="w-16 h-32 bg-gray-300 border-2 border-gray-500 rounded-t flex items-center justify-center text-gray-600 font-bold writing-vertical">
                    æ¥¼æˆ¿
                </div>
                
                {/* æ–¹æ¡ˆ1 */}
                <div className="flex flex-col items-center">
                    <div className="flex flex-col-reverse h-40 w-8 border-r-2 border-dashed border-blue-300 relative">
                        {[...Array(data.cond1.parts)].map((_, i) => (
                            <div key={i} className="w-full h-8 border-b border-blue-400 bg-blue-100 flex items-center justify-center text-[10px]">1æ®µ</div>
                        ))}
                    </div>
                    <span className="text-xs mt-1 text-blue-600">4æ®µä½™{data.cond1.extra}</span>
                </div>

                {/* æ–¹æ¡ˆ2 */}
                <div className="flex flex-col items-center">
                    <div className="flex flex-col-reverse h-40 w-8 border-r-2 border-dashed border-green-300 relative">
                        {[...Array(data.cond2.parts)].map((_, i) => (
                            <div key={i} className="w-full h-[25.6px] border-b border-green-400 bg-green-100 flex items-center justify-center text-[10px]">1æ®µ</div>
                        ))}
                    </div>
                    <span className="text-xs mt-1 text-green-600">5æ®µä½™{data.cond2.extra}</span>
                </div>
            </div>
        );

        // 5. æ—¶å…‰è½´å›¾ (å¤æ‚å¹´é¾„)
        const TimeLineVisual = ({ data }) => (
            <div className="w-full h-32 relative mt-6 px-4">
                {/* è½´çº¿ */}
                <div className="absolute top-1/2 left-4 right-4 h-1 bg-gray-300 -translate-y-1/2"></div>
                
                {/* ç‚¹ */}
                <div className="absolute top-1/2 left-4 w-4 h-4 bg-green-500 rounded-full -translate-y-1/2 -translate-x-1/2 border-2 border-white shadow"></div>
                <div className="absolute top-1/2 left-[33%] w-4 h-4 bg-blue-400 rounded-full -translate-y-1/2 -translate-x-1/2 border-2 border-white shadow"></div>
                <div className="absolute top-1/2 left-[66%] w-4 h-4 bg-blue-600 rounded-full -translate-y-1/2 -translate-x-1/2 border-2 border-white shadow"></div>
                <div className="absolute top-1/2 right-4 w-4 h-4 bg-orange-500 rounded-full -translate-y-1/2 -translate-x-1/2 border-2 border-white shadow"></div>

                {/* æ ‡æ³¨ */}
                <div className="absolute top-[65%] left-4 text-xs font-bold -translate-x-1/2">{data.low}å²</div>
                <div className="absolute top-[30%] left-[16.5%] text-xs text-gray-500 -translate-x-1/2">1ä¸ªå·®</div>
                <div className="absolute top-[65%] left-[33%] text-xs -translate-x-1/2 text-blue-500">å°æ˜</div>
                <div className="absolute top-[30%] left-[50%] text-xs text-gray-500 -translate-x-1/2">1ä¸ªå·®</div>
                <div className="absolute top-[65%] left-[66%] text-xs -translate-x-1/2 text-blue-700">è€å¸ˆ</div>
                <div className="absolute top-[30%] left-[83.5%] text-xs text-gray-500 -translate-x-1/2">1ä¸ªå·®</div>
                <div className="absolute top-[65%] right-4 text-xs font-bold -translate-x-1/2">{data.high}å²</div>
            </div>
        );

        // --- æ ¸å¿ƒç»„ä»¶ ---
        
        const Translator = ({ problem, completedSegments, setCompletedSegments, onComplete }) => {
            const interactiveSegments = problem.content.map((s, i) => ({...s, originalIndex: i})).filter(s => s.type);
            const currentInteractive = interactiveSegments.find(s => !completedSegments.has(s.originalIndex));
            const [feedback, setFeedback] = useState(null);

            useEffect(() => {
                if (!currentInteractive) {
                    onComplete();
                }
            }, [currentInteractive, onComplete]);

            const handleOptionClick = (isCorrect) => {
                if (isCorrect) {
                    setFeedback({ type: 'success', text: 'âœ… åˆ†ææ­£ç¡®ï¼' });
                    setTimeout(() => {
                        setFeedback(null);
                        const newSet = new Set(completedSegments);
                        if (currentInteractive) {
                            newSet.add(currentInteractive.originalIndex);
                        }
                        setCompletedSegments(newSet);
                    }, 600);
                } else {
                    setFeedback({ type: 'error', text: 'âŒ é€»è¾‘ä¸å¯¹å“¦ï¼Œå†è¯»è¯»é¢˜ã€‚' });
                }
            };

            if (!currentInteractive) return null;

            return (
                <div className="bg-yellow-50 border-2 border-yellow-200 p-6 rounded-2xl fade-in mt-6 shadow-sm">
                    <h3 className="font-bold text-yellow-900 mb-4 flex items-center gap-2 text-lg">
                        <span className="bg-yellow-200 text-yellow-800 text-sm px-3 py-1 rounded-full">æ€è€ƒ</span>
                        {currentInteractive.question}
                    </h3>
                    <div className="grid grid-cols-1 gap-3">
                        {currentInteractive.options.map((opt, i) => (
                            <button 
                                key={i}
                                onClick={() => handleOptionClick(opt.correct)}
                                className="text-left p-4 bg-white border border-yellow-100 rounded-xl hover:bg-yellow-100 hover:border-yellow-400 transition-all shadow-sm font-bold text-gray-700 active:scale-98"
                            >
                                {opt.text}
                            </button>
                        ))}
                    </div>
                    {feedback && (
                        <div className={`mt-4 p-3 rounded-lg text-center font-bold animate-pulse ${feedback.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                            {feedback.text}
                        </div>
                    )}
                </div>
            );
        };

        const StrategySelector = ({ onSelect }) => (
            <div className="fade-in text-center py-10">
                <h2 className="text-2xl font-bold text-slate-800 mb-2">æ¡ä»¶æ¢³ç†å®Œæ¯•ï¼</h2>
                <p className="text-slate-500 mb-8">é¢å¯¹è¿™äº›æ•°é‡å…³ç³»ï¼Œä¸‹ä¸€æ­¥è¯¥æ€ä¹ˆåŠï¼Ÿ</p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-lg mx-auto">
                    <button className="p-8 rounded-2xl border-2 border-slate-200 bg-slate-50 text-slate-400 cursor-not-allowed flex flex-col items-center gap-2">
                        <span className="text-2xl">ğŸ§®</span>
                        <span>åˆ—æ–¹ç¨‹ (å®¹æ˜“å‡ºé”™)</span>
                    </button>
                    <button onClick={onSelect} className="p-8 rounded-2xl border-2 border-blue-500 bg-white text-blue-700 font-bold hover:bg-blue-50 hover:shadow-xl transition-all transform hover:-translate-y-1 flex flex-col items-center gap-2">
                        <span className="text-2xl">âœï¸</span>
                        <span>ç”»å›¾åˆ†æ (æ¨è)</span>
                    </button>
                </div>
            </div>
        );

        const Solver = ({ data, onFinish }) => {
            const [inputs, setInputs] = useState(Array(data.questions.length).fill(""));
            const [status, setStatus] = useState(Array(data.questions.length).fill("neutral")); 

            const checkAnswer = (index, val) => {
                const newInputs = [...inputs];
                newInputs[index] = val;
                setInputs(newInputs);

                const newStatus = [...status];
                if (val.trim() === data.questions[index].answer) {
                    newStatus[index] = "correct";
                } else {
                    newStatus[index] = "neutral";
                    if (val.trim().length >= data.questions[index].answer.length && val.trim() !== data.questions[index].answer) {
                         newStatus[index] = "wrong";
                    }
                }
                setStatus(newStatus);

                if (newStatus.every(s => s === "correct")) {
                    setTimeout(onFinish, 1500);
                }
            };

            return (
                <div className="fade-in mt-6">
                    <div className="bg-white p-6 rounded-2xl border-t-4 border-blue-500 shadow-lg">
                        <h3 className="text-lg font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <span className="text-2xl">ğŸ“</span> çœ‹å›¾ Â· å¡«ç©º
                        </h3>
                        
                        <div className="mb-8 p-6 bg-slate-50 rounded-xl flex justify-center border border-slate-200 overflow-x-auto">
                            {data.type === 'age_diff' && <AgeVisual data={data} />}
                            {data.type === 'transfer' && <TransferVisual data={data} />}
                            {data.type === 'multi_transfer' && <MultiTransferVisual data={data} />}
                            {data.type === 'rope_measure' && <RopeVisual data={data} />}
                            {data.type === 'age_timeline' && <TimeLineVisual data={data} />}
                        </div>

                        <div className="space-y-4">
                            {data.questions.map((q, i) => (
                                <div key={i} className={`flex items-center justify-between p-4 rounded-xl border transition-all ${status[i] === 'correct' ? 'bg-green-50 border-green-200' : 'bg-white border-gray-100'}`}>
                                    <label className="text-slate-700 font-bold text-base flex-1 mr-4">
                                        <span className="mr-2 text-slate-400">{i+1}.</span>
                                        {q.label}
                                        {q.hint && status[i] !== 'correct' && <span className="block text-xs text-slate-400 font-normal mt-1">{q.hint}</span>}
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <input 
                                            type="text" 
                                            className={`input-box ${status[i]}`}
                                            value={inputs[i]}
                                            onChange={(e) => checkAnswer(i, e.target.value)}
                                            placeholder="?"
                                            disabled={status[i] === 'correct'}
                                            autoFocus={i === 0 || (status[i-1] === 'correct' && status[i] !== 'correct')}
                                        />
                                        <span className="text-slate-500 font-bold text-sm w-8">{q.unit}</span>
                                    </div>
                                    {status[i] === 'correct' && <span className="text-green-500 text-xl ml-2">âœ“</span>}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [currentProblemIdx, setCurrentProblemIdx] = useState(0);
            const [phase, setPhase] = useState('translate'); 
            const [completedSegments, setCompletedSegments] = useState(new Set());

            const problem = problems[currentProblemIdx];
            const phaseStepMap = { 'translate': 1, 'strategy': 2, 'solve': 3, 'success': 4 };
            const currentStep = phaseStepMap[phase];

            const nextProblem = () => {
                setCurrentProblemIdx((prev) => (prev + 1) % problems.length);
                setPhase('translate');
                setCompletedSegments(new Set()); 
            };

            return (
                <div className="max-w-3xl mx-auto p-4 min-h-screen font-sans text-slate-800">
                    <header className="mb-6 flex justify-between items-end border-b border-slate-200 pb-4">
                        <div>
                            <h1 className="text-2xl font-black text-slate-800 tracking-tight">ğŸ“ å°å­¦æ•°å­¦æ€ç»´è®­ç»ƒ v4.0</h1>
                            <p className="text-sm text-slate-500 font-medium mt-1">ç²¾é€‰é€»è¾‘é¢˜ Â· äº¤äº’å¼å›¾è§£</p>
                        </div>
                        <div className="text-right">
                            <span className="bg-blue-100 text-blue-700 text-xs px-3 py-1 rounded-full font-bold">
                                é¢˜å· {currentProblemIdx + 1} / {problems.length}
                            </span>
                        </div>
                    </header>

                    <div className="flex items-center gap-2 mb-8 px-4">
                        {['ç¿»è¯‘', 'ç­–ç•¥', 'å›¾è§£', 'å®Œæˆ'].map((label, idx) => (
                            <React.Fragment key={idx}>
                                <div className={`flex flex-col items-center gap-1 ${currentStep >= idx + 1 ? 'text-blue-600' : 'text-slate-300'}`}>
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm border-2 transition-all duration-500 ${currentStep === idx + 1 ? 'bg-blue-600 text-white border-blue-600 scale-110' : currentStep > idx + 1 ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-white border-slate-200'}`}>
                                        {idx + 1}
                                    </div>
                                    <span className="text-xs font-medium">{label}</span>
                                </div>
                                {idx < 3 && <div className={`h-1 flex-1 rounded-full mx-2 transition-all duration-500 ${currentStep > idx + 1 ? 'bg-blue-500' : 'bg-slate-100'}`}></div>}
                            </React.Fragment>
                        ))}
                    </div>

                    <div className="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm mb-6 relative overflow-hidden transition-all duration-500">
                        <div className={`absolute top-0 left-0 w-2 h-full transition-colors duration-500 ${phase === 'success' ? 'bg-green-500' : 'bg-blue-500'}`}></div>
                        <h2 className="text-xl font-bold text-slate-800 mb-4">{problem.title}</h2>
                        <div className="problem-text">
                            {problem.content.map((seg, i) => {
                                let className = "highlight-segment";
                                const isCompleted = completedSegments.has(i);
                                if (seg.type) {
                                    if (phase !== 'translate' || isCompleted) {
                                        className += " completed";
                                    } else if (phase === 'translate') {
                                        const interactiveIndices = problem.content.map((s, idx) => ({...s, idx})).filter(s => s.type).map(s => s.idx);
                                        const firstUnfinished = interactiveIndices.find(idx => !completedSegments.has(idx));
                                        if (i === firstUnfinished) className += " active";
                                    }
                                }
                                return <span key={i} className={className}>{seg.text}</span>;
                            })}
                        </div>
                    </div>

                    <div className="min-h-[300px]">
                        {phase === 'translate' && (
                            <Translator 
                                problem={problem} 
                                completedSegments={completedSegments}
                                setCompletedSegments={setCompletedSegments}
                                onComplete={() => setPhase('strategy')} 
                            />
                        )}

                        {phase === 'strategy' && <StrategySelector onSelect={() => setPhase('solve')} />}

                        {phase === 'solve' && <Solver data={problem.diagramData} onFinish={() => setPhase('success')} />}

                        {phase === 'success' && (
                            <div className="text-center py-12 fade-in bg-green-50 rounded-2xl border border-green-100">
                                <div className="text-6xl mb-4">ğŸ‰</div>
                                <h2 className="text-3xl font-black text-green-700 mb-2">æŒ‘æˆ˜æˆåŠŸï¼</h2>
                                <button onClick={nextProblem} className="mt-6 bg-green-600 hover:bg-green-700 text-white px-10 py-4 rounded-full font-bold shadow-lg transition transform hover:-translate-y-1 text-lg">
                                    ä¸‹ä¸€é¢˜ â†’
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>